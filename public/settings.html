<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Baby Shelf Organizer</title>
    <link href="/css/loader.css" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom" id="mainNav">
    <div class="container-fluid">
        <a class="navbar-brand" href="/" data-i18n="appName">Baby Shelf Organizer</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="add.html" data-i18n="add">Add</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="storageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" data-i18n="storage">
                        Storage
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="storageDropdown">
                        <li><a class="dropdown-item" id="shelf" href="location.html?id=shelf" data-i18n="shelf">Shelf</a></li>
                        <li><a class="dropdown-item" id="freezer" href="location.html?id=freezer" data-i18n="freezer">Freezer</a></li>
                    </ul>
                </li>
                <li class="nav-item"><a class="nav-link" href="shopping.html" data-i18n="shoppingList">Shopping List</a></li>
                <li class="nav-item"><a class="nav-link" href="vacation.html" data-i18n="vacationList">Vacation List</a></li>
                <li class="nav-item"><a class="nav-link" href="article.html" data-i18n="article">Article</a></li>
                <li class="nav-item"><a class="nav-link" href="stores.html" data-i18n="stores">Stores</a></li>
                <li class="nav-item"><a class="nav-link" href="qr-code.html">QR Code</a></li>
                <li class="nav-item"><a class="nav-link active" href="settings.html" data-i18n="settings">Settings</a></li>
            </ul>
            <div class="d-flex align-items-center">
                <div class="dropdown me-3">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown">
                        Loading....
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="languageDropdown" id="languageDropdownMenu">
                    </ul>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="darkModeToggle" />
                    <label class="form-check-label" for="darkModeToggle" data-i18n="darkMode">Dark Mode</label>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Main content -->
<main class="container py-5">

    <div class="card shadow mb-4">
        <div class="card-body">
            <h2 class="h5 border-bottom pb-2 mb-4" data-i18n="settings">Settings</h2>

            <!-- Default Language Dropdown -->
            <div class="mb-3">
                <label for="defaultLanguage" class="form-label" data-i18n="defaultLanguage">Default Language</label>
                <select id="defaultLanguage" class="form-select">
                </select>
            </div>

            <!-- PIN Code -->
            <!-- PIN Code -->
            <div class="mb-3">
                <label for="pinEnabled" class="form-label">Activate PIN Code</label>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="pinEnabled">
                    <label class="form-check-label" for="pinEnabled">Enable PIN</label>
                </div>

                <div id="pinInputs">
                    <label for="pinCode" class="form-label">PIN Code</label>
                    <div class="input-group mb-2">
                        <input type="password" name="pin" id="pinCode" class="form-control" maxlength="6" pattern="\d{6}" inputmode="numeric" placeholder="Enter 6-digit PIN">
                        <button class="btn btn-outline-secondary" type="button" id="togglePinBtn">Show</button>
                    </div>

                    <label for="confirmPinCode" class="form-label">Confirm PIN Code</label>
                    <div class="input-group mb-2">
                        <input type="password" name="pin" id="confirmPinCode" class="form-control" maxlength="6" pattern="\d{6}" inputmode="numeric" placeholder="Repeat 6-digit PIN">
                    </div>
                    <small class="form-text text-muted">PIN must be exactly 6 digits.</small>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Brands</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="budni" name="stores">
                    <label class="form-check-label" for="budni">Budni</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="dm" name="stores">
                    <label class="form-check-label" for="dm">DM</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="mueller" name="stores">
                    <label class="form-check-label" for="mueller">MÃ¼ller</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="rossmann" name="stores">
                    <label class="form-check-label" for="rossmann">Rossmann</label>
                </div>
            </div>

            <!-- Dark/Light Mode Toggle -->
            <div class="mb-3">
                <label class="form-label" data-i18n="defaultMode">Default Mode</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="darkModeToggleSettings">
                    <label class="form-check-label" for="darkModeToggleSettings" data-i18n="darkMode">Dark Mode</label>
                </div>
            </div>

            <div class="mb-3">
                <label for="tokenEnabled" class="form-label">Activate Tokens</label>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="tokenEnabled">
                    <label class="form-check-label" for="tokenEnabled">Enable Tokens</label>
                </div>

                <div class="d-none" id="tokenTableDiv">
                    <label class="form-label">Access Tokens</label>
                    <table class="table table-striped" id="tokensTable">
                        <thead>
                        <tr>
                            <th>Name</th>
                            <th>Created</th>
                            <th>Expires</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>

                    <div class="d-flex align-items-center gap-2">
                        <button id="generateTokenBtn" class="btn btn-success">Generate New Token</button>
                        <select id="tokenExpiration" class="form-select w-auto">
                            <option value="30">30 days</option>
                            <option value="90">90 days</option>
                            <option value="forever">Forever</option>
                        </select>
                    </div>
                </div>
            </div>

            <button id="saveModeBtn" class="btn btn-primary mt-2 mb-3" data-i18n="saveSettings">Save Settings</button>

            <!-- Locations Table -->
            <div class="mb-3">
                <label class="form-label" data-i18n="locations">Locations</label>
                <table class="table table-bordered" id="locationsTable">
                    <thead>
                    <tr>
                        <th data-i18n="location">Location</th>
                        <th data-i18n="action">Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td data-i18n="freezer">Freezer</td>
                        <td>
                            <button class="btn btn-danger btn-sm remove-row" data-i18n="delete" disabled>Delete</button>
                        </td>
                    </tr>
                    <tr>
                        <td data-i18n="shelf">Shelf</td>
                        <td>
                            <button class="btn btn-danger btn-sm remove-row" data-i18n="delete" disabled>Delete</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <div class="input-group mt-2">
                    <input type="text" id="newLocation" class="form-control" placeholder="Add new location" data-i18n-placeholder="addNewLocation">
                    <button class="btn btn-primary" id="addLocation" data-i18n="add">Add</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="/js/settings.js"></script>
</main>

<script type="module" src="/js/app.js"></script>

<script>
    const toggleBtn = document.getElementById('togglePinBtn');
    toggleBtn.addEventListener('click', () => {
        const pin = document.getElementById('pinCode');
        const confirmPin = document.getElementById('confirmPinCode');
        const show = pin.type === 'password'; // If currently hidden

        pin.type = confirmPin.type = show ? 'text' : 'password';
        toggleBtn.textContent = show ? 'Hide' : 'Show';
    });
</script>
<!-- Place this script at the bottom of your HTML -->
<script type="module">
    import {showToast} from "./js/modules/socket.js";

    const tokensTable = document.getElementById('tokensTable');
    const generateBtn = document.getElementById('generateTokenBtn');
    const expirationSelect = document.getElementById('tokenExpiration');
    const pinEnabledToggle = document.getElementById('pinEnabled');
    const tokenEnableToggle = document.getElementById('tokenEnabled');
    const pinInput = document.getElementById('pinCode');
    const confirmPinInput = document.getElementById('confirmPinCode');
    const pinInputs = document.getElementById('pinInputs');

    pinEnabledToggle.addEventListener('change', () => {
        let checked = pinEnabledToggle.checked;

        pinInputs.hidden = !checked;

        if (!checked) {
            pinInput.value = '';
            confirmPinInput.value = '';
        }
    });

    tokenEnableToggle.addEventListener('change', () => {
        let checked = tokenEnableToggle.checked;
        let div = document.getElementById('tokenTableDiv');
        if (checked) {
            div.classList.remove('d-none');
        } else {
            div.classList.add('d-none');
        }
    });

    // Delete token function
    async function deleteToken(id, btn) {
        const result = await Swal.fire({
            title: 'Are you sure?',
            text: "Do you really want to delete this token?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        });

        if (!result.isConfirmed) return;

        try {
            const res = await fetch(`/api/tokens/${id}`, { method: 'DELETE' });
            const data = await res.json();

            if (res.ok) {
                btn.closest('tr').remove();
                Swal.fire({
                    icon: 'success',
                    title: 'Token deleted',
                    toast: true,
                    position: 'top-end',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: data.error || 'Delete failed',
                    toast: true,
                    position: 'top-end',
                    timer: 3000,
                    showConfirmButton: false
                });
            }
        } catch (err) {
            console.error(err);
            Swal.fire({
                icon: 'error',
                title: 'Server error',
                toast: true,
                position: 'top-end',
                timer: 3000,
                showConfirmButton: false
            });
        }
    }

    // Render the table given an array of token objects
    function renderTokensTable(tokens) {
        const tbody = tokensTable.querySelector('tbody');
        tbody.innerHTML = '';

        tokens.forEach(token => {
            const tr = document.createElement('tr');

            tr.innerHTML = `
            <td>${token.name}</td>
            <td>${token.createdAt}</td>
            <td>${token.expiredAt}</td>
            <td><button class="btn btn-danger btn-sm">Delete</button></td>
        `;

            // Attach click listener
            tr.querySelector('button').addEventListener('click', () => deleteToken(token.id, tr.querySelector('button')));

            tbody.appendChild(tr);
        });
    }

    // Fetch tokens from the server and render them
    async function fetchTokens() {
        try {
            const res = await fetch('/api/tokens');
            const data = await res.json();
            renderTokensTable(data);
        } catch (err) {
            console.error(err);
            showToast('Error fetching tokens', 'error');
        }
    }

    // Generate token button click
    generateBtn.addEventListener('click', async () => {
        // Use SweetAlert for token name input
        const { value: name } = await Swal.fire({
            title: 'Enter token name',
            input: 'text',
            inputLabel: 'Token Name',
            inputPlaceholder: 'e.g., Home Assistant',
            inputValidator: value => !value && 'You need to enter a name!'
        });

        if (!name) return;

        const expiration = expirationSelect.value;

        try {
            const res = await fetch('/api/tokens', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, expiration })
            });

            if (!res.ok) {
                const error = await res.json();
                return showToast(error.error, 'error');
            }

            const data = await res.json();

            // Show the token above the table
            let existingAlert = document.getElementById('tokenAlert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'tokenAlert';
            alertDiv.className = 'alert alert-success d-flex justify-content-between align-items-center';
            alertDiv.style.marginBottom = '10px';
            alertDiv.innerHTML = `
    <span><strong>New Token:</strong> ${data.token}</span>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-light btn-sm">Copy</button>
        <button class="btn btn-outline-light btn-sm">&times;</button>
    </div>
`;

// Insert above the table
            tokensTable.parentElement.insertBefore(alertDiv, tokensTable);

// Copy button functionality
            const copyBtn = alertDiv.querySelector('button:first-child');
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(data.token)
                    .then(() => showToast('Token copied!', 'success'))
                    .catch(err => showToast('Failed to copy token', 'error'));
            });

// Close button functionality
            const closeBtn = alertDiv.querySelector('button:last-child');
            closeBtn.addEventListener('click', () => alertDiv.remove());

            // Update table
            fetchTokens();

        } catch (err) {
            console.error(err);
            showToast('Server error', 'danger');
        }
    });

    // Load tokens on page load
    window.addEventListener('DOMContentLoaded', fetchTokens);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>